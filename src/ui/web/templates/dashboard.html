<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FX Trading Bot Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .filters-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
            border-left: 5px solid #667eea;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
            font-size: 0.95em;
        }

        .filter-group select,
        .filter-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .filter-group select:hover,
        .filter-group input:hover {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
            font-size: 1em;
        }

        .tab-button:hover {
            color: #667eea;
        }

        .tab-button.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .metric-value {
            font-weight: 600;
            font-family: 'Courier New', monospace;
        }

        .metric-positive {
            color: #28a745;
        }

        .metric-negative {
            color: #dc3545;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3em;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .stat-card-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card-value {
            font-size: 2em;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.1em;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üìä FX Trading Bot Dashboard</h1>
            <p>Backtest Results Analysis & Visualization</p>
        </div>

        <div class="content">
            <!-- Filters Section -->
            <div class="filters-section">
                <h3>üîç Filters & Controls</h3>
                <div class="filters-grid">
                    <div class="filter-group">
                        <label for="symbolFilter">üìç Symbol:</label>
                        <select id="symbolFilter">
                            <option value="All">All Symbols</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="timeframeFilter">‚è±Ô∏è Timeframe:</label>
                        <select id="timeframeFilter">
                            <option value="All">All Timeframes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="sortBy">üìà Sort By:</label>
                        <select id="sortBy">
                            <option value="sharpe_ratio">Sharpe Ratio (Desc)</option>
                            <option value="sortino_ratio">Sortino Ratio (Desc)</option>
                            <option value="profit_factor">Profit Factor (Desc)</option>
                            <option value="roe">ROE (Desc)</option>
                        </select>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="applyFilters()">üîÑ Apply Filters</button>
                    <button class="btn-secondary" onclick="resetFilters()">‚Ü∫ Reset All</button>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="stats-grid" id="statsGrid"></div>

            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-button active" onclick="switchTab('results')">üìã Results Table</button>
                <button class="tab-button" onclick="switchTab('charts')">üìä Charts</button>
                <button class="tab-button" onclick="switchTab('comparison')">‚öñÔ∏è Comparison</button>
            </div>

            <!-- Tab: Results Table -->
            <div id="results" class="tab-content active">
                <div class="table-container">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Strategy</th>
                                <th>Symbol</th>
                                <th>Timeframe</th>
                                <th>Sharpe Ratio</th>
                                <th>Sortino Ratio</th>
                                <th>Profit Factor</th>
                                <th>Calmar Ratio</th>
                                <th>ROE</th>
                                <th>K-Ratio</th>
                                <th>Tail Ratio</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab: Charts -->
            <div id="charts" class="tab-content">
                <div class="chart-container">
                    <h3>Sharpe Ratio Comparison</h3>
                    <div id="sharpeChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Return vs Drawdown Scatter</h3>
                    <div id="scatterChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Profit Factor Comparison</h3>
                    <div id="profitFactorChart"></div>
                </div>
            </div>

            <!-- Tab: Comparison -->
            <div id="comparison" class="tab-content">
                <div class="chart-container">
                    <h3>Performance Heatmap (Sharpe Ratio)</h3>
                    <div id="heatmapChart"></div>
                </div>
                <div class="chart-container">
                    <h3>Sortino Ratio by Symbol</h3>
                    <div id="sortinoChart"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allData = [];
        let filteredData = [];

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            loadSymbols();
            loadTimeframes();
            loadResults();
        });

        function loadSymbols() {
            fetch('/api/symbols')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('symbolFilter');
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = symbol;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading symbols:', error));
        }

        function loadTimeframes() {
            fetch('/api/timeframes')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('timeframeFilter');
                    data.timeframes.forEach(tf => {
                        const option = document.createElement('option');
                        option.value = tf;
                        option.textContent = tf;
                        select.appendChild(option);
                    });
                })
                .catch(error => console.error('Error loading timeframes:', error));
        }

        function loadResults() {
            fetch('/api/results')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        allData = data.results;
                        applyFilters();
                    } else {
                        showError('Failed to load results: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error loading results:', error);
                    showError('Error loading results: ' + error);
                });
        }

        function applyFilters() {
            const symbol = document.getElementById('symbolFilter').value;
            const timeframe = document.getElementById('timeframeFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredData = allData.filter(row => {
                if (symbol !== 'All' && row.symbol !== symbol) return false;
                if (timeframe !== 'All' && row.timeframe !== timeframe) return false;
                return true;
            });

            // Sort
            filteredData.sort((a, b) => {
                let aVal = a[sortBy] || 0;
                let bVal = b[sortBy] || 0;
                return bVal - aVal;
            });

            updateResults();
            updateCharts();
            updateStats();
        }

        function resetFilters() {
            document.getElementById('symbolFilter').value = 'All';
            document.getElementById('timeframeFilter').value = 'All';
            document.getElementById('sortBy').value = 'sharpe_ratio';
            applyFilters();
        }

        function updateResults() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">No data to display</td></tr>';
                return;
            }

            filteredData.forEach(row => {
                const tr = document.createElement('tr');
                const sharpeClass = (row.sharpe_ratio || 0) > 1 ? 'metric-positive' : 'metric-negative';
                const roeClass = (row.roe || 0) > 0 ? 'metric-positive' : 'metric-negative';

                tr.innerHTML = `
                    <td><strong>${row.strategy}</strong></td>
                    <td>${row.symbol}</td>
                    <td>${row.timeframe}</td>
                    <td class="metric-value ${sharpeClass}">${(row.sharpe_ratio || 0).toFixed(2)}</td>
                    <td class="metric-value">${(row.sortino_ratio || 0).toFixed(2)}</td>
                    <td class="metric-value">${(row.profit_factor || 0).toFixed(2)}</td>
                    <td class="metric-value">${(row.calmar_ratio || 0).toFixed(2)}</td>
                    <td class="metric-value ${roeClass}">${(row.roe || 0).toFixed(2)}%</td>
                    <td class="metric-value">${(row.k_ratio || 0).toFixed(2)}</td>
                    <td class="metric-value">${(row.tail_ratio || 0).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            if (filteredData.length === 0) {
                document.getElementById('statsGrid').innerHTML = '<div class="no-data">No data available</div>';
                return;
            }

            const avgSharpe = filteredData.reduce((sum, d) => sum + (d.sharpe_ratio || 0), 0) / filteredData.length;
            const avgROE = filteredData.reduce((sum, d) => sum + (d.roe || 0), 0) / filteredData.length;
            const avgProfitFactor = filteredData.reduce((sum, d) => sum + (d.profit_factor || 0), 0) / filteredData.length;
            const bestSharpe = Math.max(...filteredData.map(d => d.sharpe_ratio || 0));

            const html = `
                <div class="stat-card">
                    <div class="stat-card-label">Avg Sharpe Ratio</div>
                    <div class="stat-card-value">${avgSharpe.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Avg ROE %</div>
                    <div class="stat-card-value">${avgROE.toFixed(1)}%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Avg Profit Factor</div>
                    <div class="stat-card-value">${avgProfitFactor.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-label">Best Sharpe</div>
                    <div class="stat-card-value">${bestSharpe.toFixed(2)}</div>
                </div>
            `;
            document.getElementById('statsGrid').innerHTML = html;
        }

        function updateCharts() {
            if (filteredData.length === 0) return;

            const labels = filteredData.map(d => `${d.symbol} ${d.timeframe}`);

            // Sharpe Ratio Bar Chart
            const sharpeTrace = {
                x: labels,
                y: filteredData.map(d => d.sharpe_ratio || 0),
                type: 'bar',
                marker: { color: 'rgba(102, 126, 234, 0.8)' }
            };
            Plotly.newPlot('sharpeChart', [sharpeTrace], {
                title: '', xaxis: { title: 'Symbol / Timeframe' }, yaxis: { title: 'Sharpe Ratio' },
                responsive: true, hovermode: 'closest'
            });

            // Scatter: ROE vs Sharpe
            const scatterTrace = {
                x: filteredData.map(d => d.roe || 0),
                y: filteredData.map(d => d.sharpe_ratio || 0),
                mode: 'markers+text',
                type: 'scatter',
                text: filteredData.map(d => d.symbol),
                textposition: 'top center',
                marker: {
                    size: 10,
                    color: filteredData.map(d => d.profit_factor || 0),
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: { title: 'Profit Factor' }
                }
            };
            Plotly.newPlot('scatterChart', [scatterTrace], {
                title: '', xaxis: { title: 'ROE %' }, yaxis: { title: 'Sharpe Ratio' },
                responsive: true, hovermode: 'closest'
            });

            // Profit Factor Bar Chart
            const profitTrace = {
                x: labels,
                y: filteredData.map(d => d.profit_factor || 0),
                type: 'bar',
                marker: { color: filteredData.map(d => d.profit_factor > 1 ? '#28a745' : '#dc3545') }
            };
            Plotly.newPlot('profitFactorChart', [profitTrace], {
                title: '', xaxis: { title: 'Symbol / Timeframe' }, yaxis: { title: 'Profit Factor' },
                responsive: true, hovermode: 'closest'
            });

            // Heatmap
            updateHeatmap();

            // Sortino Chart
            updateSortinoChart();
        }

        function updateHeatmap() {
            const symbols = [...new Set(filteredData.map(d => d.symbol))];
            const timeframes = [...new Set(filteredData.map(d => d.timeframe))];

            const z = [];
            const hoverText = [];

            timeframes.forEach(tf => {
                const row = [];
                const hoverRow = [];
                symbols.forEach(sym => {
                    const data = filteredData.find(d => d.symbol === sym && d.timeframe === tf);
                    row.push(data ? data.sharpe_ratio || 0 : 0);
                    hoverRow.push(data ? `${sym} ${tf}<br/>Sharpe: ${(data.sharpe_ratio || 0).toFixed(2)}<br/>ROE: ${(data.roe || 0).toFixed(1)}%` : '');
                });
                z.push(row);
                hoverText.push(hoverRow);
            });

            const trace = {
                z: z,
                x: symbols,
                y: timeframes,
                type: 'heatmap',
                colorscale: 'RdYlGn',
                text: hoverText,
                hoverinfo: 'text',
                colorbar: { title: 'Sharpe Ratio' }
            };

            Plotly.newPlot('heatmapChart', [trace], {
                title: '', xaxis: { title: 'Symbol' }, yaxis: { title: 'Timeframe' },
                responsive: true
            });
        }

        function updateSortinoChart() {
            const symbols = [...new Set(filteredData.map(d => d.symbol))];

            const sortinoData = symbols.map(sym => ({
                name: sym,
                x: [...new Set(filteredData.filter(d => d.symbol === sym).map(d => d.timeframe))],
                y: filteredData.filter(d => d.symbol === sym).map(d => d.sortino_ratio || 0),
                type: 'bar'
            }));

            Plotly.newPlot('sortinoChart', sortinoData, {
                title: '', xaxis: { title: 'Timeframe' }, yaxis: { title: 'Sortino Ratio' },
                barmode: 'group', responsive: true, hovermode: 'closest'
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            document.querySelector('.content').insertBefore(errorDiv, document.querySelector('.filters-section').nextSibling);
            setTimeout(() => errorDiv.remove(), 5000);
        }
    </script>
</body>

</html>